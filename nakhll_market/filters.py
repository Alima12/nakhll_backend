from django_filters import rest_framework as filters
from nakhll_market.models import BigCity, City, Category, Product, State, Tag, ProductTag
from nakhll_market.utils import split_args


class ProductFilter(filters.FilterSet):
    """Filter class for Product model with the following filters:
        * min_price: filter products with price greater than or equal to the value
        * max_price: filter products with price less than or equal to the value
        * ready: filter products that are ready to be sold
        * search: filter products that contain the value in the title
        * q: filter products that contain the value in the title
        * available: filter products that are available to be sold
        * category: filter products that are in the category or its subcategories
        * state: filter products that are in the state
        * city: filter products that are in the city
        * big_city: filter products that are in the big city
        * tags: filter products that have the tag
        * discounted: filter products that are discounted
        * shop: filter products that are in the shop
        * in_campaign: filter products which their :attr:`nakhll_market.models.Shop.in_campaign` is True
    """
    min_price = filters.NumberFilter(field_name="Price", lookup_expr='gte')
    max_price = filters.NumberFilter(field_name="Price", lookup_expr='lte')
    min_enventory=filters.NumberFilter(field_name="Inventory", lookup_expr='gte')
    max_enventory = filters.NumberFilter(field_name="Inventory", lookup_expr='lte')
    min_preparationdays= filters.NumberFilter(field_name="PreparationDays", lookup_expr='gte')
    max_preparationdays= filters.NumberFilter(field_name="PreparationDays", lookup_expr='lte')
    status = filters.CharFilter(method='filter_status')
    ready = filters.BooleanFilter(method='filter_ready')
    search = filters.CharFilter(method='filter_search')
    q = filters.CharFilter(method='filter_q')
    available = filters.BooleanFilter(method='filter_available')
    category = filters.CharFilter(method='filter_category')
    city = filters.CharFilter(method='filter_city')
    big_city = filters.CharFilter(method='filter_big_city')
    state = filters.CharFilter(method='filter_state')
    tags = filters.CharFilter(method='filter_tags')
    discounted = filters.BooleanFilter(method='filter_discounted')
    shop = filters.CharFilter(method='filter_shop')
    in_campaign = filters.BooleanFilter(method='filter_in_campaign')

    class Meta:
        model = Product
        fields = [
            'search',
            'min_price',
            'max_price',
            'min_enventory',
            'max_enventory',
            'min_preparationdays',
            'max_preparationdays',
            'status',
            'ready',
            'available',
            'category',
            'in_campaign',
            'category',
            'city',
            'discounted',
            'is_advertisement',
            'shop']

    def filter_ready(self, queryset, name, value):
        READY_IN_STOCK = '1'
        filter_queryset = {'Status': READY_IN_STOCK, 'Inventory__gt': 0}
        return queryset.filter(**filter_queryset) if value else queryset

    def filter_search(self, queryset, name, value):
        return queryset.filter(Title__icontains=value)

    def filter_q(self, queryset, name, value):
        return queryset.filter(Title__icontains=value)

    def filter_available(self, queryset, name, value):
        if value:
            AVAILABLE_IDS = ['1', '2', '3', ]
            return queryset.filter(
                Status__in=AVAILABLE_IDS, Inventory__gt=0,
                FK_Shop__Publish=True)
        return queryset

    def filter_status(self, queryset, name, value):
        if value=="آماده در انبار":
            return queryset.filter(Status__icontains=1)

        elif value=="تولید بعد از سفارش":
            return queryset.filter(Status__icontains=2)

        elif value=="سفارشی سازی فروش":
            return queryset.filter(Status__icontains=3)

        elif value=="موجود نیست":
            return queryset.filter(Status__icontains=4)


    @split_args(-1)
    def filter_category(self, queryset, name, value):
        categories = Category.objects.filter(id__in=value)
        subcategories = Category.objects.all_subcategories(categories)
        return queryset.filter(category__in=subcategories)

    # TODO: in all shops or in owenshop?

    @split_args(-1)
    def filter_tags(self, queryset, name, value):
        product_id = ProductTag.objects.filter(
            tag__id__in=value).values_list(
            'product', flat=True)
        return queryset.filter(ID__in=product_id)

    @split_args(-1)
    def filter_state(self, queryset, name, value):
        states = State.objects.filter(
            id__in=value).values_list(
            'id', flat=True)
        return queryset.filter(FK_Shop__State__in=states)

    @split_args(-1)
    def filter_big_city(self, queryset, name, value):
        big_cities = BigCity.objects.filter(
            id__in=value).values_list(
            'id', flat=True)
        return queryset.filter(FK_Shop__BigCity__in=big_cities)

    @split_args(-1)
    def filter_city(self, queryset, name, value):
        cities = City.objects.filter(
            id__in=value).values_list(
            'id', flat=True)
        return queryset.filter(FK_Shop__City__in=cities)

    def filter_discounted(self, queryset, name, value):
        return queryset.filter(OldPrice__gt=0) if value else queryset

    def filter_shop(self, queryset, name, value):
        return queryset.filter(FK_Shop__Slug=value)

    def filter_in_campaign(self, queryset, name, value):
        return queryset.filter(FK_Shop__in_campaign=True)
